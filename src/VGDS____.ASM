;;
;;    ≥²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²▀
;;    ┼  (C) 1993  Караганда  КптИ  ЭА-91-2  Пименов П.А   ┼
;; ≥²² ²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²²▀  ┼
;; ┼   VGDS.ASM - Пакет продпрограмм для работы с НГМД  ┼  ┼
;; ┼		  на "физическом" ураовне.		┼  ┼
;; ┼ ========== 52-81-95 ========= PPA Systems ======== ┼  ┼
;; ┼             Copyright  by  Пименов Паша            ┼  ┼
;; ┼  ≥²²²²²²²²²²²²²²²²²²▀    ≥²²²²²²²²²²²²²²²²²²²²²²▀  °²²▄
;; ≤²²┴ asm file: 0000h  °²²²²┴ com file: 0000h byte °²²▄
;;    ≤²²²²²²²²²²²²²²²²²²▄    ≤²²²²²²²²²²²²²²²²²²²²²²▄
;;

SYS_MDOS	EQU	0005H	; точка входа в систему

DS_STATUS	EQU 1BH	; регистр статуса EQU COM
DS_COM		EQU 1BH	; регистр команд и статуса
DS_TRACK	EQU 1AH	; регистр дорожки
DS_SECTOR	EQU 19H	; регистр сектора
DS_DATA		EQU 18H	; регистр данных
DS_MOTOR	EQU 1CH	; запуск двигателя
	PUBLIC	SET_CULIND
;;
;;   Процедура SET_CULIND производит непосредственное
;; позицирование головок текущего накопителя при этом
;; не производится контроль на номер текущей  дорожки
;; т.е  перемещение  возможно по  неотформатированому
;; диску.
;;  Так как алгоритм установки не опирается на чтение
;; номера  дорожки с диска то перемещение  происходит
;; через  "Востановление"  головок ( на 0-й цилиндр )
;; и  последующим  перемещением  головок  на заданный 
;; цилиндр при помощи команды "Поиск"  опять  же  без
;; контроля номера дорожки
╩╩   Процедуру   необходимо  вызывать  при  начальной
╩╩ инициализации контролера и НГМД╝
╩╩ Используемые процедуры╨
╩╩	PUSK - Запуск двигателя и выбор накопителя╝
╩╩	DS_WAIT - ожидание готовности контролера╝
╩╩
	PUBLIC	DS_WAIT
;;
;;
;;
;;
;;
;;
;;
;;
;;
;;
;;
;;

;;ШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШ
;; процедура установки головы накопителя на указаную дорожку
;; Вход:	А - номер дорожки

SET_CULIND:
	PUSH	PSW		;
	PUSH	PSW		; сохраняем регистр PSW
	CALL	PUSK		; запускаем двигатель на
	MVI	A,00000000B	; текущем накопителе и
	OUT	DS_COM		; производим востановление
	CALL	DS_WAIT		; головы ( 0-Culinder )
	POP	PSW		; востанавливаем нужную
	CALL	PUSK		; нам дорожку и производим
	OUT	DS_DATA		; перемещение головы
	MVI	A,00011000B	; 
	OUT	DS_COM		;
	CALL	DS_WAIT		; ожидаем готовность
	POP	PSW		;
	RET			; возврат из процедуры
;;ШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШ
DS_WAIT:
	PUSH	PSW		;процедура ожидания готовности
DS_WAIT_00:			;
	IN	DS_STATUS	;контролера НГМД
	RRC			;
	JC	DS_WAIT_00	;занято идет исполнение команды
	POP	PSW		;
	RET			;
;;ШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШ
PUSK:
	PUSH	PSW		; процедура запуска двигателя
PUSK_00:			;
	LDA	DISK_MASKA	; по заданой маске
	OUT	DS_MOTOR	; в порт управления
	CALL	DS_TIME		; делаем паузу
	IN	DS_STATUS	; читаем статус контролера
	JC	PUSK_00		; если не готов то повторить
	POP	PSW		; востановим флаги
	RET			; возврат
;;
DISK_MASKA:	DB	00H	;маска выбора рабочего накопителя
;;
;;ШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШ
DS_TIME:
	PUSH	PSW	; Типовая программа временной
	PUSH	B	; задержки
	LXI	B,3000H	; константа задержки
DS_T0:			;
	DCX	B	; пустой цикл
	MOV	A,B	; ---//----
	ORA	C	; ---//----
	JNZ	DS_T0	; ---//----
	POP	B	; востанавливает регистры
	POP	PSW	; и возвращаемся
	RET		;
;;ШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШШ
